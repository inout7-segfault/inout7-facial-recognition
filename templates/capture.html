{% extends "base.html" %}

{% block head %}

{{ super() }}

<script type="text/javascript">
  window.addEventListener('load', (() => {
    var imageCapture = null;
    var attendanceButton = null;
    attendanceButton = document.getElementById('attendanceButton');

    navigator.mediaDevices.getUserMedia({
      video: true,
      audio: false
    }).then(mediaStream => {
      imageCapture = new ImageCapture(mediaStream.getVideoTracks()[0]);
    }).catch(error => console.log(error));

    function sendPhoto() {
      if (!sessionStorage["counter"]) {
        document.getElementById('attendanceButton').disabled = true;
        sessionStorage.setItem("counter", 10);
      }
      if (Number(sessionStorage.getItem("counter")) === 0) {
        document.getElementById('attendanceButton').disabled = false;
        sessionStorage.removeItem("counter");
        return;
      }

      imageCapture.takePhoto()
        .then(blob => {
          var formData = new FormData();
          formData.append('image', blob, 'capture.png');
          var xhr = new XMLHttpRequest();
          xhr.open('POST', '/upload', true);
          //xhr.onload = function(e) { ... };
          xhr.send(formData);
        })
        .catch(error => console.log(error));

      let tmp = sessionStorage.getItem("counter");
      tmp -= 1;
      sessionStorage.setItem("counter", tmp)
      setTimeout(sendPhoto, 10000);
    }

    attendanceButton.addEventListener('click', sendPhoto, false);
  }));
</script>
{% endblock %}

{% block title %}Capture{% endblock %}

{% block content %}

<button id="attendanceButton">Take Attendance</button>

{% endblock  %}
